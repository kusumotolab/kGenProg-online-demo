<!DOCTYPE html>
<html lang="en">
<head>
    <title>ACE in Action</title>
</head>
<body>
<div id="logo">
    <a href="./">
        <img class="logo-img" src="logo.png">
        <h1>kGenProg demo</h1>
        <link rel="stylesheet" href="index.css">
    </a>
</div>

<span id="forkongithub"><a href="https://github.com/kusumotolab/kGenProg/">Fork me on GitHub</a></span>
<div id="ctrl">
    <a href="#" id="run" class="button button-run">Repair</a>
    <a href="#" class="button button-other">Download</a>
    <a href="#" id="refresh" class="button button-other">#dummy</a>
</div>

<div class="editor">
    <div class="header">source</div>
    <div id="src" class="ace"></div>
</div>
<div class="editor">
    <div class="header">test</div>
    <div id="test" class="ace"></div>
</div>

<div class="editor">
    <div class="header">console</div>
    <div id="console" class="ace"></div>
</div>

<script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>

</body>


<script>
    let key = 0;
    // let src = ace.edit('src');
    // let test = ace.edit('test');
    // let console = ace.edit('console');

    setupAce = function (key, readonly = false) {
        const editor = ace.edit(key);
        editor.setTheme('ace/theme/xcode');
        editor.session.setMode('ace/mode/java');
        editor.setOptions({
            showGutter: true,
            minLines: 35,
            printMargin: false,
        });

        if (readonly) {
            editor.setOptions({
                readOnly: true,
                highlightActiveLine: false,
                highlightGutterLine: false
            });
            editor.renderer.$cursorLayer.element.style.display = "none"
        }
    };

    setupAce('src');
    setupAce('test');
    setupAce('console', readonly = true)
    ace.edit('console').insert('kgp console here........\n');
    ace.edit('console').insert('kgp console here........\n');
    ace.edit('console').insert('kgp console here........\n');

    const loadDefaultSrc = function () {
        fetch('./default-src.java')
            .then(resp => resp.text())
            .then(text => ace.edit('src').insert(text));
    };
    const loadDefaultTest = function () {
        fetch('./default-test.java')
            .then(resp => resp.text())
            .then(text => ace.edit('test').insert(text));
    };

    const assignRun = function () {
        document.querySelector('#run').addEventListener('click', () => {
            let src = ace.edit('src').getValue();
            let test = ace.edit('test').getValue();
            src = src.replace("&gt;", ">");
            src = src.replace("&lt;", "<");
            test = test.replace("&gt;", ">");
            test = test.replace("&lt;", "<");
            const data = {src: src, test: test};
            console.log(data);

            fetch('./api/submission',
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                .then(checkFetchError)
                .then(text => key = text.key)
                .catch(err => console.error(err))
        });
    };

    const assignDebugRefresh = function () {
        document.querySelector('#refresh').addEventListener('click', () => {
            if (key === 0) {
                return;
            }
            fetch('./api/status/' + key)
                .then(checkFetchError)
                .then(text => {
                    ace.edit('console').setValue(text.stdout);
                    x = text;
                })
                .catch(err => console.error(err));
            //document.querySelector('#console').innerHTML = 'aaaaaaaaaa';/////////
        });
    };

    const checkFetchError = function (resp) {
        console.log(resp); /////////
        if (resp.status >= 200 && resp.status <= 299) {
            return resp.json();
        }
        throw Error(resp);
    };

    setInterval(() => {
        if (key === 0) {
            return;
        }
        fetch('./api/status/' + key)
            .then(checkFetchError)
            .then(text => {
                ace.edit('console').setValue(text.stdout);
                const area = document.querySelector('#console');
                area.scrollTop = area.scrollHeight;
            })
            .catch(err => console.error(err));
    }, 1000);


    loadDefaultSrc();
    loadDefaultTest();
    assignRun();
    assignDebugRefresh();

</script>

</html>